<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>My Guru OMR Smart Marker</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      font-size: 18px;
      padding: 20px;
      background: #f4f4f4;
      color: #000;
      text-align: center;
    }
    .logo {
      width: 120px;
      border-radius: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      margin-bottom: 10px;
    }
    h1 { font-size: 28px; margin-bottom: 20px; }
    .form-section {
      display: flex; flex-direction: column; gap: 15px;
      max-width: 600px; margin: 0 auto; text-align: left;
    }
    label { font-weight: bold; }
    input[type="file"], select {
      font-size: 16px; padding: 6px; width: 100%;
    }
    button {
      font-size: 18px; padding: 10px 20px;
      background: #007bff; color: #fff; border: none;
      border-radius: 6px; cursor: pointer; width: fit-content;
    }
    button:hover { background: #0056b3; }
    #result, #log { margin-top: 20px; font-size: 16px; white-space: pre-line; text-align: left; }
  </style>
</head>
<body>
  <img src="static/logo.png" class="logo" alt="OMR Icon" />
  <h1>ğŸ“˜ My Guru OMR Smart Marker</h1>
  <div class="form-section">
    <label>ğŸ« é€‰æ‹©å­¦æ ¡/è€ƒè¯•ï¼š</label>
    <select id="school">
      <option value="SJKC">SJKC (åå°)</option>
      <option value="SK">SK</option>
      <option value="SM">SM</option>
      <option value="SMK">SMK</option>
      <option value="SPM">SPM</option>
      <option value="STPM">STPM</option>
      <option value="UPSR">UPSR</option>
      <option value="UASA">UASA</option>
      <option value="PT3">PT3</option>
      <option value="SEKOLAH_SENI">SEKOLAH SENI</option>
      <option value="SEKOLAH_SUKAN">SEKOLAH SUKAN</option>
      <option value="VOKASIONAL">VOKASIONAL</option>
    </select>

    <label>ğŸ“„ ä¸Šä¼  Skema Jawapanï¼š</label>
    <input type="file" id="skema" accept=".jpg,.jpeg,.png,.pdf,.docx" />

    <label>ğŸ“¸ ä¸Šä¼ å­¦ç”Ÿç­”é¢˜å¡ (å¯å¤šå¼ )ï¼š</label>
    <input type="file" id="students" multiple accept=".jpg,.jpeg,.png" />

    <button onclick="simulateAd()">â–¶ï¸ çœ‹å¹¿å‘Šæ‰¹æ”¹ï¼ˆ+5å¼ ï¼‰</button>
    <button id="gradeBtn">ğŸ” æ‰¹æ”¹ / Start Grading</button>
    <button onclick="exportExcel()">ğŸ“¥ å¯¼å‡ºæˆç»© Excel</button>
  </div>

  <div id="log"></div>
  <div id="result"></div>

  <script type="module">
    import { AdMob, BannerAdSize, BannerAdPosition } from 'capacitor-admob';

    // âœ… ä½ çš„åç«¯åœ°å€
    const apiUrl = 'https://myguru-omr-smart-marker.onrender.com';

    let credit = 0, results = [];

    // âœ… åˆå§‹åŒ– AdMob
    AdMob.initialize();

    // âœ… æ¨ªå¹…å¹¿å‘Š
    AdMob.showBanner({
      adId: "ca-app-pub-4570977068750116/8840720847",
      adSize: BannerAdSize.ADAPTIVE_BANNER,
      position: BannerAdPosition.BOTTOM_CENTER
    });

    async function showInterstitial() {
      await AdMob.prepareInterstitial({
        adId: "ca-app-pub-4570977068750116/5589082998"
      });
      await AdMob.showInterstitial();
    }

    async function simulateAd() {
      await showInterstitial();
      credit += 5;
      document.getElementById("log").innerText = `âœ… å¯æ‰¹æ”¹å­¦ç”Ÿæ•°ï¼š${credit}`;
    }

    async function gradeAll() {
      const skema = document.getElementById("skema").files[0];
      const students = document.getElementById("students").files;
      const school = document.getElementById("school").value;

      if (!skema || students.length === 0) return alert("è¯·ä¸Šä¼  Skema å’Œç­”é¢˜å¡ï¼");
      if (students.length > credit) return alert("è¯·å…ˆçœ‹å¹¿å‘Šå¢åŠ é¢åº¦ï¼");

      results = [];
      for (let s of students) {
        const f = new FormData();
        f.append("skema", skema);
        f.append("student", s);
        f.append("school", school);

        const res = await fetch(`${apiUrl}/grade`, { method: "POST", body: f });
        const data = await res.json();
        results.push(data);
        credit--;
      }

      document.getElementById("result").innerText = results.map(r =>
        `ğŸ‘¤ ${r.name || "Unknown"}
ğŸ¯ ${r.score}/${r.total} = ${(r.score/r.total*100).toFixed(1)}%
âœ… ${r.correct.join(", ")}
âŒ ${r.incorrect.join(", ")}`
      ).join("\n\n");

      document.getElementById("log").innerText = `å‰©ä½™å¯æ‰¹æ”¹ï¼š${credit}`;

      await showInterstitial();
    }

    document.getElementById("gradeBtn").addEventListener("click", gradeAll);

    function exportExcel() {
      window.location.href = `${apiUrl}/export-excel`;
    }
  </script>
</body>
</html>
